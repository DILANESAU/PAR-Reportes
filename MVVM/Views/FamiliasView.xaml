<UserControl x:Class="WPF_PAR.MVVM.Views.FamiliasView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:lvc="clr-namespace:LiveChartsCore.SkiaSharpView.WPF;assembly=LiveChartsCore.SkiaSharpView.WPF"
             mc:Ignorable="d" 
             d:DesignHeight="900" d:DesignWidth="1400"
             TextElement.Foreground="{DynamicResource MaterialDesignBody}"
             FontFamily="{DynamicResource MaterialDesignFont}">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
    </UserControl.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" CornerRadius="15" Margin="0,0,0,20" Padding="20">
            <Border.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                    <GradientStop Color="#F5F7FA" Offset="0.0"/>
                    <GradientStop Color="#E4E8F0" Offset="1.0"/>
                </LinearGradientBrush>
            </Border.Background>
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel VerticalAlignment="Center">
                    <TextBlock Text="Análisis de Familias" FontSize="24" FontWeight="Black" Foreground="{DynamicResource PrimaryHueMidBrush}"/>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="Vista General" Opacity="0.6" FontSize="13" 
                                   Visibility="{Binding VerResumen, Converter={StaticResource BoolToVis}}"/>
                        <TextBlock Text="{Binding TituloDetalle, StringFormat='Detalle: {0}'}" 
                                   Opacity="0.8" FontSize="13" FontWeight="Bold" Foreground="{DynamicResource PrimaryHueMidBrush}"
                                   Visibility="{Binding VerDetalle, Converter={StaticResource BoolToVis}}"/>
                    </StackPanel>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">

                    <Button Command="{Binding RegresarCommand}" Style="{StaticResource MaterialDesignOutlinedButton}" 
                            Margin="0,0,15,0" Content="VOLVER" Height="40"
                            Visibility="{Binding VerDetalle, Converter={StaticResource BoolToVis}}"/>

                    <materialDesign:Card UniformCornerRadius="20" Padding="5" Margin="0,0,10,0" VerticalAlignment="Center">
                        <ComboBox ItemsSource="{Binding Filters.ListaSucursales}"
                                  SelectedValue="{Binding Filters.SucursalId}"
                                  DisplayMemberPath="Value"
                                  SelectedValuePath="Key"
                                  Style="{StaticResource MaterialDesignComboBox}"
                                  materialDesign:TextFieldAssist.UnderlineBrush="Transparent"
                                  BorderThickness="0" FontWeight="SemiBold" Padding="15,8" Width="160"
                                  materialDesign:HintAssist.Hint="Sucursal"/>
                    </materialDesign:Card>

                    <materialDesign:Card UniformCornerRadius="20" Padding="5" Margin="0,0,10,0" VerticalAlignment="Center">
                        <DatePicker SelectedDate="{Binding Filters.FechaInicio}" Width="110" 
                                    materialDesign:TextFieldAssist.UnderlineBrush="Transparent" BorderThickness="0" Padding="10,5"/>
                    </materialDesign:Card>

                    <materialDesign:Card UniformCornerRadius="20" Padding="5" Margin="0,0,10,0" VerticalAlignment="Center">
                        <DatePicker SelectedDate="{Binding Filters.FechaFin}" Width="110" 
                                    materialDesign:TextFieldAssist.UnderlineBrush="Transparent" BorderThickness="0" Padding="10,5"/>
                    </materialDesign:Card>

                    <Button Command="{Binding ActualizarCommand}" Style="{StaticResource MaterialDesignFloatingActionMiniButton}" 
                            Height="40" Width="40" ToolTip="Actualizar Datos">
                        <materialDesign:PackIcon Kind="Magnify"/>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <UniformGrid Grid.Row="1" Columns="3" Margin="0,0,0,20">
            <materialDesign:Card UniformCornerRadius="20" Margin="0,0,15,0" Padding="20">
                <StackPanel>
                    <TextBlock Text="Venta Total Global" Opacity="0.6" FontSize="12" FontWeight="SemiBold"/>
                    <TextBlock Text="{Binding GranTotalVenta, StringFormat=C2}" FontSize="26" FontWeight="Bold" Foreground="#1565C0"/>
                </StackPanel>
            </materialDesign:Card>

            <materialDesign:Card UniformCornerRadius="20" Margin="0,0,15,0" Padding="20">
                <StackPanel>
                    <TextBlock Text="Volumen Total" Opacity="0.6" FontSize="12" FontWeight="SemiBold"/>
                    <TextBlock Text="{Binding GranTotalLitros, StringFormat=N0}" FontSize="26" FontWeight="Bold" Foreground="#4CAF50"/>
                    <TextBlock Text="Litros" FontSize="10" Opacity="0.5"/>
                </StackPanel>
            </materialDesign:Card>

            <materialDesign:Card UniformCornerRadius="20" Padding="0" Cursor="Hand" Background="#E3F2FD">
                <Button Command="{Binding ExportarGlobalCommand}" 
                        Style="{StaticResource MaterialDesignFlatButton}" 
                        Height="Auto" 
                        Content="{Binding TituloReporteCard}" 
                        Foreground="#1565C0" 
                        FontWeight="Bold"/>
            </materialDesign:Card>
        </UniformGrid>

        <Grid Grid.Row="2">

            <ScrollViewer VerticalScrollBarVisibility="Auto" Visibility="{Binding VerResumen, Converter={StaticResource BoolToVis}}">
                <ItemsControl ItemsSource="{Binding TarjetasFamilias}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <materialDesign:Card Width="260" Margin="0,0,20,20" UniformCornerRadius="15" materialDesign:ElevationAssist.Elevation="Dp2">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <Border Background="{Binding ColorFondo}" Height="6" CornerRadius="15,15,0,0"/>

                                    <StackPanel Grid.Row="1" Margin="20">
                                        <TextBlock Text="{Binding NombreFamilia}" FontWeight="Bold" FontSize="16" TextTrimming="CharacterEllipsis"/>

                                        <TextBlock Text="{Binding VentaTotal, StringFormat=C2}" FontSize="24" FontWeight="Black" Margin="0,10,0,0" Foreground="#333"/>
                                        <TextBlock Text="{Binding PorcentajeParticipacion, StringFormat='Part: {0:P1}'}" FontSize="12" Foreground="Gray"/>

                                        <Separator Margin="0,10"/>

                                        <Grid>
                                            <StackPanel Orientation="Horizontal">
                                                <materialDesign:PackIcon Kind="BucketOutline" VerticalAlignment="Center" Margin="0,0,5,0" Opacity="0.5"/>
                                                <TextBlock Text="{Binding LitrosTotal, StringFormat=N0}" FontWeight="SemiBold"/>
                                                <TextBlock Text=" L" Opacity="0.6"/>
                                            </StackPanel>
                                            
                                        </Grid>
                                    </StackPanel>

                                    <Button Grid.Row="2" Style="{StaticResource MaterialDesignFlatButton}" 
                                            Command="{Binding DataContext.VerDetalleCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding NombreFamilia}"
                                            Content="VER DETALLE" Foreground="{Binding ColorFondo}" HorizontalAlignment="Right"/>
                                </Grid>
                            </materialDesign:Card>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>


            <ScrollViewer VerticalScrollBarVisibility="Auto" Visibility="{Binding VerDetalle, Converter={StaticResource BoolToVis}}">
                <Grid Margin="0,0,10,0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <materialDesign:Card Grid.Row="0" Margin="0,0,0,20" Padding="15" UniformCornerRadius="10">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,20,0">
                                <materialDesign:PackIcon Kind="FilterVariant" VerticalAlignment="Center" Margin="0,0,5,0" Opacity="0.5"/>
                                <ComboBox ItemsSource="{Binding SubLineasDisponibles}"
                                          SelectedItem="{Binding SubLineaSeleccionada}"
                                          Width="150"
                                          materialDesign:HintAssist.Hint="Filtrar Sub-Línea"
                                          Style="{StaticResource MaterialDesignFloatingHintComboBox}"/>
                            </StackPanel>

                            <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                                <TextBlock Text="Ver Colores (Sin Blancos)" VerticalAlignment="Center" Margin="0,0,10,0" FontWeight="SemiBold"/>
                                <ToggleButton IsChecked="{Binding ExcluirBlancos}" Style="{StaticResource MaterialDesignSwitchToggleButton}"/>
                            </StackPanel>

                            <StackPanel Grid.Column="3" Orientation="Horizontal" VerticalAlignment="Center">
                                <TextBlock Text="Mostrar Top:" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                <ComboBox ItemsSource="{Binding OpcionesTop}" SelectedItem="{Binding TopSeleccionado}" Width="60" FontWeight="Bold"/>
                            </StackPanel>
                        </Grid>
                    </materialDesign:Card>

                    <Grid Grid.Row="1" Margin="0,0,0,20" Height="350">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <materialDesign:Card Grid.Column="0" UniformCornerRadius="20" Margin="0,0,10,0" Padding="10">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                <TextBlock Text="{Binding TituloGraficoPastel}" FontWeight="Bold" Margin="10"/>
                                <lvc:PieChart Grid.Row="1" Series="{Binding SeriesPastelDinero}" LegendPosition="Right"/>
                            </Grid>
                        </materialDesign:Card>

                        <materialDesign:Card Grid.Column="1" UniformCornerRadius="20" Margin="10,0,0,0" Padding="10">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                <TextBlock Text="Distribución por Volumen (Litros)" FontWeight="Bold" Margin="10"/>
                                <lvc:PieChart Grid.Row="1" Series="{Binding SeriesPastelLitros}" LegendPosition="Right"/>
                            </Grid>
                        </materialDesign:Card>
                    </Grid>

                    <Grid Grid.Row="2" Margin="0,0,0,20" Height="{Binding AlturaGraficaDinamica}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <materialDesign:Card Grid.Column="0" UniformCornerRadius="20" Margin="0,0,10,0" Padding="10">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                <TextBlock Text="{Binding TituloBarrasClientes}" FontWeight="Bold" Margin="10"/>
                                <lvc:CartesianChart Grid.Row="1" Series="{Binding SeriesBarrasClientes}" 
                                                    XAxes="{Binding EjeXBarrasClientes}" 
                                                    YAxes="{Binding EjeYBarrasClientes}"
                                                    ZoomMode="Y" TooltipPosition="Top"/>
                            </Grid>
                        </materialDesign:Card>

                        <materialDesign:Card Grid.Column="1" UniformCornerRadius="20" Margin="10,0,0,0" Padding="10">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                <TextBlock Text="{Binding TituloBarrasProductos}" FontWeight="Bold" Margin="10"/>
                                <lvc:CartesianChart Grid.Row="1" Series="{Binding SeriesBarrasProductos}" 
                                                    XAxes="{Binding EjeXBarrasProductos}" 
                                                    YAxes="{Binding EjeYBarrasProductos}"
                                                    ZoomMode="Y" TooltipPosition="Top"/>
                            </Grid>
                        </materialDesign:Card>
                    </Grid>

                    <materialDesign:Card Grid.Row="3" UniformCornerRadius="20" Padding="0" Margin="0,0,0,20">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="500"/>
                            </Grid.RowDefinitions>

                            <Border Background="#F5F5F5" Padding="15">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBox Text="{Binding TextoBusqueda, UpdateSourceTrigger=PropertyChanged}" 
                                             materialDesign:HintAssist.Hint="Buscar en la tabla..." 
                                             materialDesign:TextFieldAssist.UnderlineBrush="{DynamicResource PrimaryHueMidBrush}"
                                             Style="{StaticResource MaterialDesignFloatingHintTextBox}"
                                             Width="300" HorizontalAlignment="Left"/>
                                </Grid>
                            </Border>

                            <DataGrid Grid.Row="1" ItemsSource="{Binding DetalleVentas}" 
                                      AutoGenerateColumns="False" 
                                      IsReadOnly="True" 
                                      HeadersVisibility="Column" 
                                      GridLinesVisibility="Horizontal" 
                                      Background="White"
                                      CanUserSortColumns="True">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Descripción" Binding="{Binding Descripcion}" Width="*"/>
                                    <DataGridTextColumn Header="Línea" Binding="{Binding Linea}" Width="150"/>
                                    <DataGridTextColumn Header="Litros" Binding="{Binding LitrosTotales, StringFormat=N0}" Width="100"/>
                                    <DataGridTextColumn Header="Venta ($)" Binding="{Binding TotalVenta, StringFormat=C2}" Width="120" FontWeight="Bold"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </materialDesign:Card>

                </Grid>
            </ScrollViewer>
        </Grid>

        <Grid Style="{StaticResource LoadingOverlayStyle}" Grid.RowSpan="3">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}" 
                             Value="0" IsIndeterminate="True" 
                             Width="50" Height="50" Foreground="{DynamicResource PrimaryHueMidBrush}"/>

                <TextBlock Text="Procesando datos..." 
                           Margin="0,20,0,0" FontWeight="SemiBold" 
                           HorizontalAlignment="Center" Opacity="0.6"/>
            </StackPanel>
        </Grid>
    </Grid>

</UserControl>