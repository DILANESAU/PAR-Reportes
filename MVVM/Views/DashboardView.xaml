<UserControl x:Class="WPF_PAR.MVVM.Views.DashboardView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:cv="clr-namespace:WPF_PAR.Core.Converters"
             xmlns:lvc="clr-namespace:LiveChartsCore.SkiaSharpView.WPF;assembly=LiveChartsCore.SkiaSharpView.WPF"
             mc:Ignorable="d" 
             d:DesignHeight="950" d:DesignWidth="1600"
             TextElement.Foreground="{DynamicResource MaterialDesignBody}"
             Background="Transparent"
             FontFamily="{DynamicResource MaterialDesignFont}">
    
    <UserControl.Resources>
        <cv:MontoColorConverter x:Key="MontoColorConv"/>
    </UserControl.Resources>
    <Grid>
        <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="30">
        <Grid MaxWidth="1800">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <Grid Margin="0,40,0,30">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel>
                    <TextBlock Text="Resumen General" FontSize="24" FontWeight="Bold"/>
                    <TextBlock Text="Indicadores clave de rendimiento" Opacity="0.6"/>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal">

                    <materialDesign:Card UniformCornerRadius="6" Padding="5" Margin="0,0,10,0">
                        <ComboBox ItemsSource="{Binding Sucursales}"
                                  SelectedItem="{Binding SucursalSeleccionada}"
                                  DisplayMemberPath="Nombre"
                                  Width="180" 
                                  materialDesign:HintAssist.Hint="Sucursal"
                                  Style="{StaticResource MaterialDesignFilledComboBox}"/>
                    </materialDesign:Card>

                    <materialDesign:Card UniformCornerRadius="6" Padding="5">
                        <ComboBox ItemsSource="{Binding Periodos}"
                                  SelectedItem="{Binding PeriodoSeleccionado}"
                                  Width="150"
                                  materialDesign:HintAssist.Hint="Periodo"
                                  Style="{StaticResource MaterialDesignFilledComboBox}"/>
                    </materialDesign:Card>

                    <Button Style="{StaticResource MaterialDesignFloatingActionMiniButton}"
                            Command="{Binding ActualizarCommand}"
                            ToolTip="Forzar actualización"
                            Width="35" Height="35" Margin="15,0,0,0"
                            Background="{DynamicResource PrimaryHueMidBrush}"
                            BorderBrush="{DynamicResource PrimaryHueMidBrush}">
                        <materialDesign:PackIcon Kind="Refresh"/>
                    </Button>
                </StackPanel>
            </Grid>

            <UniformGrid Grid.Row="1" Rows="1" Margin="0,0,-20,30">

                <materialDesign:Card Style="{StaticResource KpiCardBaseStyle}">
                    <Grid>
                        <StackPanel>
                            <TextBlock Text="INGRESOS NETOS" FontSize="12" FontWeight="Bold" Opacity="0.6"/>
                            <TextBlock Text="{Binding KpiVentas, StringFormat=C2}" FontSize="28" FontWeight="Black" Margin="0,10"/>
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="CheckCircle" Foreground="#4CAF50"/>
                                <TextBlock Text="Calculado en tiempo real" Foreground="#4CAF50" Margin="5,0,0,0" FontWeight="SemiBold" FontSize="11"/>
                            </StackPanel>
                        </StackPanel>
                        <materialDesign:PackIcon Kind="CurrencyUsd" Width="40" Height="40" Opacity="0.1"
                                                 HorizontalAlignment="Right" VerticalAlignment="Top"/>
                    </Grid>
                </materialDesign:Card>

                <materialDesign:Card Style="{StaticResource KpiCardBaseStyle}">
                    <Grid>
                        <StackPanel>
                            <TextBlock Text="TRANSACCIONES" FontSize="12" FontWeight="Bold" Opacity="0.6"/>
                            <TextBlock Text="{Binding KpiTransacciones, StringFormat=N0}" FontSize="28" FontWeight="Black" Margin="0,10"/>
                            <TextBlock Text="Tickets cerrados" Opacity="0.5" FontStyle="Italic"/>
                        </StackPanel>
                        <materialDesign:PackIcon Kind="ReceiptText" Width="40" Height="40" Opacity="0.1" 
                                                 HorizontalAlignment="Right" VerticalAlignment="Top"/>
                    </Grid>
                </materialDesign:Card>

                <materialDesign:Card Style="{StaticResource KpiCardBaseStyle}">
                    <Grid>
                        <StackPanel>
                            <TextBlock Text="CLIENTES ACTIVOS" FontSize="12" FontWeight="Bold" Opacity="0.6"/>
                            <TextBlock Text="{Binding KpiClientes, StringFormat=N0}" FontSize="28" FontWeight="Black" Margin="0,10"/>
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="Account" Foreground="#FF9800"/>
                                <TextBlock Text="En este periodo" Foreground="#FF9800" Margin="5,0,0,0" FontWeight="SemiBold"/>
                            </StackPanel>
                        </StackPanel>
                        <materialDesign:PackIcon Kind="AccountGroup" Width="40" Height="40" Opacity="0.1" 
                                                 HorizontalAlignment="Right" VerticalAlignment="Top"/>
                    </Grid>
                </materialDesign:Card>
            </UniformGrid>

                <Grid Grid.Row="2">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="2*"/>
                        <ColumnDefinition Width="1*"/>
                    </Grid.ColumnDefinitions>

                    <materialDesign:Card Grid.Column="0" Style="{StaticResource ContentCardStyle}" Height="400">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <StackPanel>
                                <TextBlock Text="Tendencia de Ingresos" FontSize="18" FontWeight="Bold"/>
                                <TextBlock Text="Comportamiento histórico anual" FontSize="12" Opacity="0.5"/>
                            </StackPanel>

                            <lvc:CartesianChart Grid.Row="1" 
                                            Series="{Binding SeriesVentas}" 
                                            XAxes="{Binding EjeX}" 
                                            YAxes="{Binding EjeY}" 
                                            Margin="0,20,0,0"
                                            Background="Transparent"
                                            LegendPosition="Top">
                            </lvc:CartesianChart>
                        </Grid>
                    </materialDesign:Card>

                    <materialDesign:Card Grid.Column="1" Style="{StaticResource ContentCardStyle}" Height="400">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <TextBlock Text="Top Clientes del Periodo" FontSize="18" FontWeight="Bold"/>

                            <ItemsControl Grid.Row="1" ItemsSource="{Binding TopProductosList}" Margin="0,15,0,0">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="0,8">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>

                                            <Border Background="{DynamicResource MaterialDesignDivider}" CornerRadius="5" Width="25" Height="25">
                                                <TextBlock Text="{Binding Ranking}" HorizontalAlignment="Center" VerticalAlignment="Center" 
                                                       FontWeight="Bold" Opacity="0.5"/>
                                            </Border>

                                            <TextBlock Grid.Column="1" Text="{Binding Nombre}" Margin="10,0" VerticalAlignment="Center" TextTrimming="CharacterEllipsis"/>

                                            <TextBlock Grid.Column="2" Text="{Binding Monto, StringFormat=C0}" FontWeight="SemiBold" Foreground="#4CAF50"/>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Grid>
                    </materialDesign:Card>
                </Grid>

                <Grid Grid.Row="3" Margin="0,30,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="2.5*"/>
                        <ColumnDefinition Width="1*"/>
                    </Grid.ColumnDefinitions>

                    <materialDesign:Card Grid.Column="0" Style="{StaticResource ContentCardStyle}" Margin="0,0,15,0">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                <materialDesign:PackIcon Kind="TableLarge" VerticalAlignment="Center" Opacity="0.5"/>
                                <TextBlock Text="Últimas Transacciones" FontSize="16" FontWeight="Bold" Margin="10,0,0,0"/>
                            </StackPanel>

                            <DataGrid Grid.Row="1" 
                                ItemsSource="{Binding ListaVentas}"
                                AutoGenerateColumns="False" 
                                HeadersVisibility="Column"
                                IsReadOnly="True"
                                GridLinesVisibility="Horizontal"
                                Background="Transparent"
                                BorderThickness="0"
                                MaxHeight="350">

                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Suc" 
                                        Binding="{Binding Sucursal}" 
                                        Width="Auto"
                                        ElementStyle="{StaticResource MaterialDesignDataGridTextColumnStyle}"/>

                                    <DataGridTextColumn Header="Fecha" 
                                        Binding="{Binding FechaEmision, StringFormat=dd/MM HH:mm}" 
                                        Width="Auto" 
                                        ElementStyle="{StaticResource MaterialDesignDataGridTextColumnStyle}"/>

                                    <DataGridTextColumn Header="Mov" 
                                        Binding="{Binding Mov}" 
                                        Width="Auto" 
                                        ElementStyle="{StaticResource MaterialDesignDataGridTextColumnStyle}"/>

                                    <DataGridTemplateColumn Header="Folio" Width="Auto">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding MovID}" FontWeight="Bold"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>

                                    <DataGridTextColumn Header="Cliente" Binding="{Binding Cliente}" Width="*">
                                        <DataGridTextColumn.ElementStyle>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
                                                <Setter Property="ToolTip" Value="{Binding Cliente}"/>
                                                <Setter Property="VerticalAlignment" Value="Center"/>
                                                <Setter Property="Margin" Value="5,0"/>
                                            </Style>
                                        </DataGridTextColumn.ElementStyle>
                                    </DataGridTextColumn>

                                    <DataGridTemplateColumn Header="Total" Width="Auto" MinWidth="80">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding TotalVenta, StringFormat=C2}" 
                                                    Foreground="{Binding TotalVenta,  Converter={StaticResource MontoColorConv}}"
                                                    FontWeight="SemiBold" 
                                                    HorizontalAlignment="Right"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </materialDesign:Card>

                    <materialDesign:Card Grid.Column="1" Style="{StaticResource ContentCardStyle}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                                <materialDesign:PackIcon Kind="AccountClock" VerticalAlignment="Center" Opacity="0.5"/>
                                <TextBlock Text="Clientes Recientes" FontSize="16" FontWeight="Bold" Margin="10,0,0,0"/>
                            </StackPanel>

                            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" MaxHeight="350">
                                <ItemsControl ItemsSource="{Binding UltimosClientesList}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Margin="0,8">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <Border Width="35" Height="35" CornerRadius="20" Background="{DynamicResource PrimaryHueLightBrush}">
                                                    <TextBlock Text="{Binding Iniciales}" 
                                               HorizontalAlignment="Center" VerticalAlignment="Center"
                                               FontWeight="Bold" Foreground="{DynamicResource PrimaryHueMidBrush}"/>
                                                </Border>

                                                <StackPanel Grid.Column="1" Margin="10,0,0,0" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding Nombre}" FontWeight="SemiBold" TextTrimming="CharacterEllipsis"/>
                                                    <TextBlock Text="{Binding Fecha, StringFormat='Hace: dd/MM HH:mm'}" FontSize="11" Opacity="0.5"/>
                                                </StackPanel>
                                            </Grid>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Grid>
                    </materialDesign:Card>
                </Grid>
            </Grid>
                </ScrollViewer>
                    <Grid Visibility="{Binding IsLoading, Converter={StaticResource BoolToVis}}"
                        Panel.ZIndex="100">
                    <Grid Background="{DynamicResource MaterialDesignPaper}" Opacity="0.7"/>
                        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                            <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}"
                                Value="0" IsIndeterminate="True"
                                Width="50" Height="50"/>
                            <TextBlock Text="Cargando datos..." 
                                HorizontalAlignment="Center" 
                                Margin="0,15,0,0" FontWeight="Bold"/>
                        </StackPanel>
                    </Grid>
                <materialDesign:Snackbar MessageQueue="{Binding ErrorMessageQueue}"
                         HorizontalAlignment="Stretch"
                         VerticalAlignment="Bottom"
                         Background="{DynamicResource MaterialDesignPaper}"
                         Foreground="{DynamicResource MaterialDesignBody}" 
                         Margin="16"/>
    </Grid>

</UserControl>