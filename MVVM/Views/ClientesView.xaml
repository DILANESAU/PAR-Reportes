<UserControl x:Class="WPF_PAR.MVVM.Views.ClientesView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             TextElement.Foreground="{DynamicResource MaterialDesignBody}"
             Background="{DynamicResource MaterialDesignPaper}">

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <StackPanel Grid.Row="0" Margin="0,0,0,15">
            <TextBlock Text="Análisis de Cartera de Clientes" Style="{StaticResource MaterialDesignHeadline5TextBlock}" FontWeight="Bold"/>
            <TextBlock Text="Compara el desempeño de ventas contra el mismo periodo del año anterior." Opacity="0.6"/>
        </StackPanel>

        <materialDesign:Card Grid.Row="1" Margin="0,0,0,20" Padding="20" UniformCornerRadius="8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <materialDesign:PackIcon Kind="StoreMarker" VerticalAlignment="Center" Margin="0,0,10,0" Foreground="{DynamicResource PrimaryHueMidBrush}"/>
                    <ComboBox materialDesign:HintAssist.Hint="Sucursal" Width="200" Margin="0,0,20,0"
                        Style="{StaticResource MaterialDesignFloatingHintComboBox}"
                        ItemsSource="{Binding DataContext.ListaSucursales, RelativeSource={RelativeSource AncestorType=Window}}"
                        SelectedValue="{Binding Filters.SucursalId}"
                        DisplayMemberPath="Value"
                        SelectedValuePath="Key"/>

                    <DatePicker materialDesign:HintAssist.Hint="Desde" Width="120" Margin="0,0,15,0"
                        Style="{StaticResource MaterialDesignFloatingHintDatePicker}"
                        SelectedDate="{Binding Filters.FechaInicio}"/>

                    <DatePicker materialDesign:HintAssist.Hint="Hasta" Width="120" Margin="0,0,15,0"
                        Style="{StaticResource MaterialDesignFloatingHintDatePicker}"
                        SelectedDate="{Binding Filters.FechaFin}"/>

                    <Button Command="{Binding ActualizarCommand}" Content="ANALIZAR"
                            Style="{StaticResource MaterialDesignRaisedButton}"
                            Height="35" materialDesign:ButtonAssist.CornerRadius="4" Margin="0,0,15,0"/>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Bottom">
                    <TextBlock Text="Ordenar por:" VerticalAlignment="Center" Margin="0,0,10,0" Opacity="0.7"/>

                    <RadioButton Style="{StaticResource MaterialDesignChoiceChipOutlineRadioButton}"
                                 Command="{Binding OrdenarMejoresCommand}" IsChecked="True"
                                 Content="🏆 Mejores Ventas" Margin="0,0,8,0"/>

                    <RadioButton Style="{StaticResource MaterialDesignChoiceChipOutlineRadioButton}"
                                 Command="{Binding OrdenarPeoresCommand}"
                                 Content="⚠️ En Riesgo (Baja)" />
                </StackPanel>
            </Grid>
        </materialDesign:Card>

        <materialDesign:Card Grid.Row="2" UniformCornerRadius="8" Padding="0" VerticalAlignment="Stretch">
            <DataGrid ItemsSource="{Binding ListaClientes}" 
                      Style="{StaticResource ModernDataGrid}" 
                      ColumnHeaderStyle="{StaticResource ModernColumnHeader}">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="CLIENTE" Binding="{Binding Nombre}" Width="3*"/>

                    <DataGridTextColumn Header="PERIODO ANTERIOR" Binding="{Binding VentaAnterior, StringFormat=C2}" Width="*" Foreground="Gray">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="HorizontalAlignment" Value="Right"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <DataGridTextColumn Header="PERIODO ACTUAL" Binding="{Binding VentaActual, StringFormat=C2}" Width="*" FontWeight="Bold">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="HorizontalAlignment" Value="Right"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <DataGridTemplateColumn Header="VARIACIÓN $" Width="1.2*">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">

                                    <materialDesign:PackIcon VerticalAlignment="Center" Margin="0,0,5,0" Width="16" Height="16">
                                        <materialDesign:PackIcon.Style>
                                            <Style TargetType="materialDesign:PackIcon">
                                                <Setter Property="Kind" Value="TrendingUp"/>
                                                <Setter Property="Foreground" Value="Green"/>

                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Estado}" Value="⚠️ En Riesgo">
                                                        <Setter Property="Kind" Value="TrendingDown"/>
                                                        <Setter Property="Foreground" Value="Red"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </materialDesign:PackIcon.Style>
                                    </materialDesign:PackIcon>

                                    <TextBlock Text="{Binding Diferencia, StringFormat=C2}" FontWeight="Bold" VerticalAlignment="Center">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Foreground" Value="Green"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Estado}" Value="⚠️ En Riesgo">
                                                        <Setter Property="Foreground" Value="Red"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>

                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTextColumn Header="%" Binding="{Binding PorcentajeCambio, StringFormat={}{0:N1}%}" Width="0.8*">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="HorizontalAlignment" Value="Right"/>
                                <Setter Property="Padding" Value="0,0,15,0"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                </DataGrid.Columns>
            </DataGrid>
        </materialDesign:Card>

        <Grid Grid.RowSpan="3" Background="#90FFFFFF" 
              Visibility="{Binding IsLoading, Converter={StaticResource BoolToVis}}">
            <materialDesign:Card UniformCornerRadius="10" Padding="30" HorizontalAlignment="Center" VerticalAlignment="Center">
                <StackPanel>
                    <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}" Value="0" IsIndeterminate="True"/>
                    <TextBlock Text="Analizando ventas..." Margin="0,15,0,0" FontWeight="Bold"/>
                </StackPanel>
            </materialDesign:Card>
        </Grid>
    </Grid>
</UserControl>